<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>对话主题 1D KDE 可视化（每个 Topic 一条带）</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          'Segoe UI',
          sans-serif;
        margin: 16px;
        background: #f7f7f7;
      }
      h1 {
        font-size: 20px;
        margin-bottom: 8px;
      }
      #message {
        font-size: 13px;
        color: #666;
        margin: 4px 0 10px;
      }
      #chart-container {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        padding: 12px;
        overflow-x: auto;
      }
      svg {
        font-size: 11px;
      }
      .topic-label {
        dominant-baseline: middle;
        fill: #333;
      }
      .axis text {
        fill: #888;
      }
      .axis path,
      .axis line {
        stroke: #ccc;
      }
    </style>
  </head>
  <body>
    <h1>对话主题 1D KDE 可视化（版本 1：每个 Topic 一条带）</h1>
    <div id="message">使用说明：直接在源码中修改 <code>rawData</code> 即可。</div>

    <div id="chart-container">
      <svg id="chart"></svg>
    </div>

    <script>
      const rawData = [
        {
          topic: '自我价值与形象',
          slots: [
            {
              sentence:
                '我是不是就是个废物？别人一战就上岸，我考了四年才勉强考上，现在还是个普通一本，我这辈子是不是完了？',
              slot: '自我怀疑',
              id: 1,
              color: '#B0CFF6',
              sentiment: -0.9,
            },
          ],
          color: '#1E77E8',
        },
        {
          topic: '心理健康与压力管理',
          slots: [
            {
              sentence:
                '我是不是就是个废物？别人一战就上岸，我考了四年才勉强考上，现在还是个普通一本，我这辈子是不是完了？',
              slot: '自我怀疑与自卑',
              id: 1,
              color: '#D9C9F0',
              sentiment: -0.9,
            },
          ],
          color: '#9366D6',
        },
        {
          topic: '自我价值与形象',
          slots: [
            {
              sentence: '你对自己很狠，评价的时候只看“比别人差”，不看“自己扛过了什么”。',
              slot: '自我评价标准',
              id: 2,
              color: '#B0CFF6',
              sentiment: -0.7,
            },
            {
              sentence: '你现在有几个典型的“心里陷阱”：',
              slot: '心理陷阱',
              id: 2,
              color: '#B0CFF6',
              sentiment: -0.5,
            },
            {
              sentence: '普通一本 ≠ 这辈子完了',
              slot: '普通一本的价值',
              id: 2,
              color: '#B0CFF6',
              sentiment: 0.1,
            },
            {
              sentence: '你真正值得骄傲的地方',
              slot: '自我骄傲的特质',
              id: 2,
              color: '#B0CFF6',
              sentiment: 0.5,
            },
            {
              sentence: '你不是废物，你只是走了一条更辛苦、更慢热的路线。',
              slot: '自我肯定',
              id: 2,
              color: '#B0CFF6',
              sentiment: 0.8,
            },
          ],
          color: '#1E77E8',
        },
        {
          topic: '心理健康与压力管理',
          slots: [
            {
              sentence: '你绝对不是废物。',
              slot: '自我肯定',
              id: 2,
              color: '#D9C9F0',
              sentiment: 0.8,
            },
            {
              sentence: '你现在有几个典型的“心里陷阱”：',
              slot: '心理陷阱识别',
              id: 2,
              color: '#D9C9F0',
              sentiment: 0.1,
            },
            {
              sentence: '普通一本 ≠ 这辈子完了',
              slot: '普通学历与未来可能性',
              id: 2,
              color: '#D9C9F0',
              sentiment: 0.5,
            },
            {
              sentence: '允许自己难过，但别在“完了”这一步卡死',
              slot: '情绪管理与接受',
              id: 2,
              color: '#D9C9F0',
              sentiment: 0.3,
            },
            {
              sentence: '如果你有更严重的想法……',
              slot: '严重心理问题识别',
              id: 2,
              color: '#D9C9F0',
              sentiment: -0.7,
            },
          ],
          color: '#9366D6',
        },
        {
          topic: '自我价值与形象',
          slots: [
            {
              sentence: '我感觉未来找工作好困难，我怕毕业就失业了',
              slot: '就业焦虑',
              id: 3,
              color: '#B0CFF6',
              sentiment: -0.8,
            },
            {
              sentence: '我现在学的是计算机专业',
              slot: '专业选择',
              id: 3,
              color: '#B0CFF6',
              sentiment: 0,
            },
          ],
          color: '#1E77E8',
        },
        {
          topic: '就业与经济压力',
          slots: [
            {
              sentence: '我现在学的是计算机专业，我感觉未来找工作好困难，我怕毕业就失业了',
              slot: '毕业失业担忧',
              id: 3,
              color: '#FFC9A9',
              sentiment: -0.8,
            },
          ],
          color: '#FF660C',
        },
        {
          topic: '人际关系与社交',
          slots: [
            {
              sentence: '我现在学的是计算机专业，我感觉未来找工作好困难，我怕毕业就失业了',
              slot: '就业焦虑',
              id: 3,
              color: '#B4E6B4',
              sentiment: -0.8,
            },
          ],
          color: '#2BBA2B',
        },
        {
          topic: '健康与减肥',
          slots: [
            {
              sentence: '我现在学的是计算机专业，我感觉未来找工作好困难，我怕毕业就失业了',
              slot: '就业焦虑',
              id: 3,
              color: '#F9B3B3',
              sentiment: -0.8,
            },
          ],
          color: '#EF2628',
        },
        {
          topic: '心理健康与压力管理',
          slots: [
            {
              sentence: '我现在学的是计算机专业，我感觉未来找工作好困难，我怕毕业就失业了',
              slot: '就业焦虑',
              id: 3,
              color: '#D9C9F0',
              sentiment: -0.6,
            },
          ],
          color: '#9366D6',
        },
        {
          topic: '语言学习与自我提升',
          slots: [
            {
              sentence: '我想学的是计算机专业，我感觉未来找工作好困难，我怕毕业就失业了',
              slot: '就业焦虑',
              id: 3,
              color: '#D6C3BF',
              sentiment: -0.7,
            },
          ],
          color: '#8C5649',
        },
        {
          topic: '健康与减肥',
          slots: [
            {
              sentence:
                '我看到网上天天说前端毕业就失业了，还有哪些上班的天天996，压力很大，身体出一些毛病。',
              slot: '职业压力',
              id: 5,
              color: '#F9B3B3',
              sentiment: -0.7,
            },
          ],
          color: '#EF2628',
        },
        {
          topic: '就业与经济压力',
          slots: [
            {
              sentence:
                '我看到身边的同学每个人都收到大厂的offer和工作，压力好大，我怕每次我毕业之后啥也找不到，就失业，辜负父母的期待。',
              slot: '同学就业压力',
              id: 7,
              color: '#FFC9A9',
              sentiment: -0.9,
            },
          ],
          color: '#FF660C',
        },
        {
          topic: '人际关系与社交',
          slots: [
            {
              sentence:
                '我看到身边的同学每个人都收到大厂的offer和工作，压力好大，我怕每次我毕业之后啥也找不到，就失业，辜负父母的期待。',
              slot: '同辈压力',
              id: 7,
              color: '#B4E6B4',
              sentiment: -0.9,
            },
          ],
          color: '#2BBA2B',
        },
        {
          topic: '健康与减肥',
          slots: [
            {
              sentence:
                '我看到身边的同学每个人都收到大厂的offer和工作，压力好大，我怕每次我毕业之后啥也找不到，就失业，辜负父母的期待。',
              slot: '就业压力',
              id: 7,
              color: '#F9B3B3',
              sentiment: -0.9,
            },
          ],
          color: '#EF2628',
        },
        {
          topic: '心理健康与压力管理',
          slots: [
            {
              sentence:
                '我看到身边的同学每个人都收到大厂的offer和工作，压力好大，我怕每次我毕业之后啥也找不到，就失业，辜负父母的期待。',
              slot: '同辈压力与父母期待',
              id: 7,
              color: '#D9C9F0',
              sentiment: -0.8,
            },
          ],
          color: '#9366D6',
        },
        {
          topic: '人际关系与社交',
          slots: [
            {
              sentence: '别人都说考研上岸就解放了，为什么我上岸了反而更绝望？',
              slot: '考研后的失落',
              id: 9,
              color: '#B4E6B4',
              sentiment: -0.7,
            },
          ],
          color: '#2BBA2B',
        },
        {
          topic: '心理健康与压力管理',
          slots: [
            {
              sentence: '别人都说考研上岸就解放了，为什么我上岸了反而更绝望？',
              slot: '考研后绝望感',
              id: 9,
              color: '#D9C9F0',
              sentiment: -0.7,
            },
          ],
          color: '#9366D6',
        },
        {
          topic: '就业与经济压力',
          slots: [
            {
              sentence: '我怕我爸妈看到我还是这个死样子会失望死，我该怎么办？',
              slot: '父母期待压力',
              id: 11,
              color: '#FFC9A9',
              sentiment: -0.9,
            },
          ],
          color: '#FF660C',
        },
        {
          topic: '人际关系与社交',
          slots: [
            {
              sentence:
                '我特别怕毕业那天一个人搬行李回老家，我怕我爸妈看到我还是这个死样子会失望死，我该怎么办？',
              slot: '毕业后的孤独感',
              id: 11,
              color: '#B4E6B4',
              sentiment: -0.9,
            },
          ],
          color: '#2BBA2B',
        },
        {
          topic: '心理健康与压力管理',
          slots: [
            {
              sentence:
                '我特别怕毕业那天一个人搬行李回老家，我怕我爸妈看到我还是这个死样子会失望死，我该怎么办？',
              slot: '毕业后的家庭压力',
              id: 11,
              color: '#D9C9F0',
              sentiment: -0.9,
            },
          ],
          color: '#9366D6',
        },
        {
          topic: '自我价值与形象',
          slots: [
            {
              sentence: '我怕我连死都做不好。',
              slot: '自我伤害的恐惧',
              id: 13,
              color: '#B0CFF6',
              sentiment: -0.9,
            },
          ],
          color: '#1E77E8',
        },
        {
          topic: '就业与经济压力',
          slots: [
            {
              sentence:
                '我确实有想过一死了之，但是我连自杀都不敢，我怕我死了我妈会疯，我怕我连死都做不好。',
              slot: '极端情绪与经济压力',
              id: 13,
              color: '#FFC9A9',
              sentiment: -1,
            },
          ],
          color: '#FF660C',
        },
        {
          topic: '心理健康与压力管理',
          slots: [
            {
              sentence:
                '我确实有想过一死了之，但是我连自杀都不敢，我怕我死了我妈会疯，我怕我连死都做不好。',
              slot: '自杀念头与家庭责任',
              id: 13,
              color: '#D9C9F0',
              sentiment: -1.0,
            },
          ],
          color: '#9366D6',
        },
        {
          topic: '就业与经济压力',
          slots: [
            {
              sentence:
                '我在学校也没什么朋友，我跟同学之间的关系也不好，平时也没有什么活动可以参加，我不知道跟谁说内心的话',
              slot: '社交孤立与经济压力',
              id: 15,
              color: '#FFC9A9',
              sentiment: -0.8,
            },
          ],
          color: '#FF660C',
        },
        {
          topic: '人际关系与社交',
          slots: [
            {
              sentence:
                '我在学校也没什么朋友，我跟同学之间的关系也不好，平时也没有什么活动可以参加，我不知道跟谁说内心的话',
              slot: '缺乏社交支持',
              id: 15,
              color: '#B4E6B4',
              sentiment: -0.8,
            },
          ],
          color: '#2BBA2B',
        },
        {
          topic: '心理健康与压力管理',
          slots: [
            {
              sentence:
                '我在学校也没什么朋友，我跟同学之间的关系也不好，平时也没有什么活动可以参加，我不知道跟谁说内心的话',
              slot: '社交孤立与情感表达',
              id: 15,
              color: '#D9C9F0',
              sentiment: -0.8,
            },
          ],
          color: '#9366D6',
        },
        {
          topic: '自我价值与形象',
          slots: [
            {
              sentence: '我长相普通，家里也没什么钱，我还很胖，我在学校里面不敢跟别人打招呼说话',
              slot: '外貌与自卑',
              id: 17,
              color: '#B0CFF6',
              sentiment: -0.8,
            },
            {
              sentence: '我从来没有谈过恋爱，甚至女生的手都没有牵过',
              slot: '恋爱经历缺乏',
              id: 19,
              color: '#B0CFF6',
              sentiment: -0.7,
            },
          ],
          color: '#1E77E8',
        },
        {
          topic: '就业与经济压力',
          slots: [
            {
              sentence:
                '我长这么大从来没有谈过恋爱，甚至女生的手都没有牵过，我也很少有女性朋友，其实我是很想去谈恋爱，但是我根本找不到',
              slot: '恋爱与经济压力',
              id: 19,
              color: '#FFC9A9',
              sentiment: -0.7,
            },
          ],
          color: '#FF660C',
        },
        {
          topic: '人际关系与社交',
          slots: [
            {
              sentence:
                '我长这么大从来没有谈过恋爱，甚至女生的手都没有牵过，我也很少有女性朋友，其实我是很想去谈恋爱，但是我根本找不到',
              slot: '恋爱缺失',
              id: 19,
              color: '#B4E6B4',
              sentiment: -0.9,
            },
          ],
          color: '#2BBA2B',
        },
        {
          topic: '心理健康与压力管理',
          slots: [
            {
              sentence:
                '我长这么大从来没有谈过恋爱，甚至女生的手都没有牵过，我也很少有女性朋友，其实我是很想去谈恋爱，但是我根本找不到',
              slot: '恋爱与社交焦虑',
              id: 19,
              color: '#D9C9F0',
              sentiment: -0.7,
            },
          ],
          color: '#9366D6',
        },
        {
          topic: '自我价值与形象',
          slots: [
            {
              sentence: '我平常没有课的时候，我就只会在宿舍呆着打游戏，也不想去别的地方。',
              slot: '社交孤立',
              id: 21,
              color: '#B0CFF6',
              sentiment: -0.6,
            },
          ],
          color: '#1E77E8',
        },
        {
          topic: '就业与经济压力',
          slots: [
            {
              sentence:
                '我没什么特长，我平常没有课的时候，我就只会在宿舍呆着打游戏，也不想去别的地方。',
              slot: '缺乏特长与经济压力',
              id: 21,
              color: '#FFC9A9',
              sentiment: -0.6,
            },
          ],
          color: '#FF660C',
        },
        {
          topic: '人际关系与社交',
          slots: [
            {
              sentence:
                '我没什么特长，我平常没有课的时候，我就只会在宿舍呆着打游戏，也不想去别的地方。',
              slot: '缺乏兴趣爱好',
              id: 21,
              color: '#B4E6B4',
              sentiment: -0.7,
            },
          ],
          color: '#2BBA2B',
        },
        {
          topic: '心理健康与压力管理',
          slots: [
            {
              sentence:
                '我没什么特长，我平常没有课的时候，我就只会在宿舍呆着打游戏，也不想去别的地方。',
              slot: '缺乏特长与社交动力',
              id: 21,
              color: '#D9C9F0',
              sentiment: -0.6,
            },
          ],
          color: '#9366D6',
        },
        {
          topic: '自我价值与形象',
          slots: [
            {
              sentence: '我看到别人情侣一块，我会很羡慕',
              slot: '对情侣的羡慕',
              id: 25,
              color: '#B0CFF6',
              sentiment: -0.7,
            },
            {
              sentence: '我想减肥，你觉得我应该怎么做，我现在170cm，180斤',
              slot: '减肥计划',
              id: 27,
              color: '#B0CFF6',
              sentiment: 0.2,
            },
          ],
          color: '#1E77E8',
        },
        {
          topic: '就业与经济压力',
          slots: [
            {
              sentence: '我想减肥，你觉得我应该怎么做，我现在170cm，180斤',
              slot: '减肥与经济压力',
              id: 27,
              color: '#FFC9A9',
              sentiment: -0.5,
            },
          ],
          color: '#FF660C',
        },
        {
          topic: '健康与减肥',
          slots: [
            {
              sentence: '我想减肥，你觉得我应该怎么做，我现在170cm，180斤',
              slot: '减肥计划',
              id: 27,
              color: '#F9B3B3',
              sentiment: 0.3,
            },
          ],
          color: '#EF2628',
        },
        {
          topic: '心理健康与压力管理',
          slots: [
            {
              sentence: '我想减肥，你觉得我应该怎么做，我现在170cm，180斤',
              slot: '减肥计划与身体焦虑',
              id: 27,
              color: '#D9C9F0',
              sentiment: -0.5,
            },
          ],
          color: '#9366D6',
        },
        {
          topic: '语言学习与自我提升',
          slots: [
            {
              sentence: '我想减肥，你觉得我应该怎么做，我现在170cm，180斤',
              slot: '减肥计划',
              id: 27,
              color: '#D6C3BF',
              sentiment: -0.1,
            },
          ],
          color: '#8C5649',
        },
        {
          topic: '自我价值与形象',
          slots: [
            {
              sentence: '长得丑就是原罪',
              slot: '外貌歧视',
              id: 35,
              color: '#B0CFF6',
              sentiment: -0.9,
            },
          ],
          color: '#1E77E8',
        },
        {
          topic: '就业与经济压力',
          slots: [
            {
              sentence:
                '我感觉我的长相普通，甚至说有点丑，我感觉世界是一个巨大的卡颜局，对外貌不好的人来说，恶意真的太大了。',
              slot: '外貌与经济压力',
              id: 35,
              color: '#FFC9A9',
              sentiment: -0.8,
            },
          ],
          color: '#FF660C',
        },
        {
          topic: '心理健康与压力管理',
          slots: [
            {
              sentence:
                '我感觉我的长相普通，甚至说有点丑，我感觉世界是一个巨大的卡颜局，对外貌不好的人来说，恶意真的太大了。',
              slot: '外貌焦虑',
              id: 35,
              color: '#D9C9F0',
              sentiment: -0.9,
            },
          ],
          color: '#9366D6',
        },
        {
          topic: '语言学习与自我提升',
          slots: [
            {
              sentence:
                '我感觉我的长相普通，甚至说有点丑，我感觉世界是一个巨大的卡颜局，对外貌不好的人来说，恶意真的太大了。',
              slot: '外貌焦虑',
              id: 35,
              color: '#D6C3BF',
              sentiment: -0.8,
            },
          ],
          color: '#8C5649',
        },
        {
          topic: '就业与经济压力',
          slots: [
            {
              sentence:
                '我刷到别人说‘长得丑就是原罪’，我一照镜子就想把自己脸抓花，我是不是真的没资格被爱？',
              slot: '外貌自卑与经济压力',
              id: 37,
              color: '#FFC9A9',
              sentiment: -1,
            },
          ],
          color: '#FF660C',
        },
        {
          topic: '心理健康与压力管理',
          slots: [
            {
              sentence:
                '我刷到别人说‘长得丑就是原罪’，我一照镜子就想把自己脸抓花，我是不是真的没资格被爱？',
              slot: '外貌自卑与自我伤害',
              id: 37,
              color: '#D9C9F0',
              sentiment: -1.0,
            },
          ],
          color: '#9366D6',
        },
        {
          topic: '自我价值与形象',
          slots: [
            {
              sentence: '我一照镜子就觉得自己好丑，穿的也土，人也胖',
              slot: '自我形象不满',
              id: 39,
              color: '#B0CFF6',
              sentiment: -0.8,
            },
          ],
          color: '#1E77E8',
        },
        {
          topic: '就业与经济压力',
          slots: [
            {
              sentence: '我一照镜子就觉得自己好丑，穿的也土，人也胖',
              slot: '外貌自卑与经济压力',
              id: 39,
              color: '#FFC9A9',
              sentiment: -0.9,
            },
          ],
          color: '#FF660C',
        },
        {
          topic: '心理健康与压力管理',
          slots: [
            {
              sentence: '我一照镜子就觉得自己好丑，穿的也土，人也胖',
              slot: '自我形象焦虑',
              id: 39,
              color: '#D9C9F0',
              sentiment: -0.9,
            },
          ],
          color: '#9366D6',
        },
        {
          topic: '人际关系与社交',
          slots: [
            {
              sentence: '我想和女生谈恋爱，但是我不知道怎么跟她们交流，以及去哪里认识女生',
              slot: '恋爱社交困难',
              id: 45,
              color: '#B4E6B4',
              sentiment: -0.8,
            },
          ],
          color: '#2BBA2B',
        },
        {
          topic: '语言学习与自我提升',
          slots: [
            {
              sentence: '我们可以做一个“从 0 社交到有可能恋爱”的路线',
              slot: '社交与恋爱计划',
              id: 46,
              color: '#D6C3BF',
              sentiment: 0.5,
            },
          ],
          color: '#8C5649',
        },
        {
          topic: '人际关系与社交',
          slots: [
            {
              sentence: '其实我挺害怕回家的，因为每次回家家里人都会催我相亲',
              slot: '家庭相亲压力',
              id: 47,
              color: '#B4E6B4',
              sentiment: -0.8,
            },
          ],
          color: '#2BBA2B',
        },
        {
          topic: '语言学习与自我提升',
          slots: [
            {
              sentence: '其实我挺害怕回家的，因为每次回家家里人都会催我相亲',
              slot: '回家压力',
              id: 47,
              color: '#D6C3BF',
              sentiment: -0.7,
            },
          ],
          color: '#8C5649',
        },
        {
          topic: '人际关系与社交',
          slots: [
            {
              sentence: '我现在还没有毕业，相亲的时候总是被女方嫌弃',
              slot: '相亲挫败感',
              id: 49,
              color: '#B4E6B4',
              sentiment: -0.9,
            },
          ],
          color: '#2BBA2B',
        },
        {
          topic: '语言学习与自我提升',
          slots: [
            {
              sentence:
                '有的时候我一直没人说，没人能理解我，同时他们还经常嘲笑我，我表面没有反应，其实我内心很难受的',
              slot: '社交孤独感',
              id: 57,
              color: '#D6C3BF',
              sentiment: -0.85,
            },
            {
              sentence: '对，其实我把心里的话说出来就舒服多了',
              slot: '表达和分享情感',
              id: 57,
              color: '#D6C3BF',
              sentiment: 0.4,
            },
            {
              sentence: '我总是不太敢在别人面前唱',
              slot: '唱歌胆怯',
              id: 61,
              color: '#D6C3BF',
              sentiment: -0.4,
            },
            {
              sentence: '我平均生活费只有1500，每天吃饭开销就要40块',
              slot: '生活费预算',
              id: 65,
              color: '#D6C3BF',
              sentiment: -0.5,
            },
          ],
          color: '#8C5649',
        },
        {
          topic: '健康与减肥',
          slots: [
            {
              sentence: '我昨天听了你的建议去健身房，今天练完之后全身酸痛',
              slot: '健身后的酸痛',
              id: 69,
              color: '#F9B3B3',
              sentiment: -0.2,
            },
          ],
          color: '#EF2628',
        },
        {
          topic: '语言学习与自我提升',
          slots: [
            {
              sentence: '我昨天听了你的建议去健身房，今天练完之后全身酸痛',
              slot: '身体锻炼体验',
              id: 69,
              color: '#D6C3BF',
              sentiment: 0.3,
            },
          ],
          color: '#8C5649',
        },
        {
          topic: '健康与减肥',
          slots: [
            {
              sentence: '但是我看到别人的重量都好大，我根本举不起来，像是哑铃我只能据5kg的',
              slot: '健身自卑',
              id: 71,
              color: '#F9B3B3',
              sentiment: -0.6,
            },
            {
              sentence: '昨天我练了手臂还有腿，现在感觉胳膊都抬不起来了，走路也是很痛',
              slot: '健身后的酸痛',
              id: 75,
              color: '#F9B3B3',
              sentiment: -0.5,
            },
          ],
          color: '#EF2628',
        },
        {
          topic: '语言学习与自我提升',
          slots: [
            {
              sentence: '昨天我练了手臂还有腿，现在感觉胳膊都抬不起来了，走路也是很痛',
              slot: '锻炼后的恢复建议',
              id: 75,
              color: '#D6C3BF',
              sentiment: -0.3,
            },
          ],
          color: '#8C5649',
        },
        {
          topic: '健康与减肥',
          slots: [
            {
              sentence: '但是我感觉确实，运动完之后，心情会好一点',
              slot: '运动后的心情改善',
              id: 77,
              color: '#F9B3B3',
              sentiment: 0.5,
            },
            {
              sentence: '运动和改善心情有帮助吗',
              slot: '运动与心情改善',
              id: 79,
              color: '#F9B3B3',
              sentiment: 0.4,
            },
          ],
          color: '#EF2628',
        },
        {
          topic: '人际关系与社交',
          slots: [
            {
              sentence:
                '有没有一些不需要花很多钱就可以参加的社交活动，我也很想交朋友，有人陪我说话',
              slot: '寻找低成本社交活动',
              id: 85,
              color: '#B4E6B4',
              sentiment: -0.2,
            },
            {
              sentence: '我怎么约其他人打呢，就是哪些平时交流比较少的朋友，可以直接叫人家去吗',
              slot: '约人社交困难',
              id: 89,
              color: '#B4E6B4',
              sentiment: -0.5,
            },
            {
              sentence: '其实我的英语水平也不行，我口语很烂，我平常不敢跟人交流，用英语更加不会了',
              slot: '英语交流障碍',
              id: 93,
              color: '#B4E6B4',
              sentiment: -0.8,
            },
            {
              sentence:
                '我感觉我没有在其他人面前展示自己的信心，当然也没有啥可以展示的，例如每次点到我上去介绍自己或者表演节目，我都是摆摆手',
              slot: '缺乏自信',
              id: 97,
              color: '#B4E6B4',
              sentiment: -0.9,
            },
          ],
          color: '#2BBA2B',
        },
        {
          topic: '语言学习与自我提升',
          slots: [
            {
              sentence: '我和别人说话的时候或者在讲台上的时候，有什么动作可以让我看起来自信一点',
              slot: '提高自信的肢体语言',
              id: 99,
              color: '#D6C3BF',
              sentiment: 0.4,
            },
          ],
          color: '#8C5649',
        },
        {
          topic: '自我价值与形象',
          slots: [
            {
              sentence: '我晚上很容易失眠',
              slot: '失眠问题',
              id: 103,
              color: '#B0CFF6',
              sentiment: -0.6,
            },
          ],
          color: '#1E77E8',
        },
        {
          topic: '就业与经济压力',
          slots: [
            {
              sentence: '我晚上很容易失眠',
              slot: '失眠与经济压力',
              id: 103,
              color: '#FFC9A9',
              sentiment: -0.7,
            },
          ],
          color: '#FF660C',
        },
        {
          topic: '健康与减肥',
          slots: [
            {
              sentence: '我晚上很容易失眠',
              slot: '失眠问题',
              id: 103,
              color: '#F9B3B3',
              sentiment: -0.6,
            },
          ],
          color: '#EF2628',
        },
        {
          topic: '心理健康与压力管理',
          slots: [
            {
              sentence: '我晚上很容易失眠',
              slot: '失眠与睡眠问题',
              id: 103,
              color: '#D9C9F0',
              sentiment: -0.7,
            },
          ],
          color: '#9366D6',
        },
        {
          topic: '自我价值与形象',
          slots: [
            {
              sentence: '我很容易睡觉的时候乱想，尤其是想我为什么这么普通，过得生活很没有意义',
              slot: '生活意义的质疑',
              id: 105,
              color: '#B0CFF6',
              sentiment: -0.9,
            },
          ],
          color: '#1E77E8',
        },
        {
          topic: '就业与经济压力',
          slots: [
            {
              sentence:
                '我很容易睡觉的时候乱想，尤其是想我为什么这么普通，过得生活很没有意义，然后我对茶和咖啡也比较容易过敏，很容易睡不着',
              slot: '失眠与自我怀疑',
              id: 105,
              color: '#FFC9A9',
              sentiment: -0.9,
            },
          ],
          color: '#FF660C',
        },
        {
          topic: '健康与减肥',
          slots: [
            {
              sentence:
                '我很容易睡觉的时候乱想，尤其是想我为什么这么普通，过得生活很没有意义，然后我对茶和咖啡也比较容易过敏，很容易睡不着',
              slot: '睡前焦虑',
              id: 105,
              color: '#F9B3B3',
              sentiment: -0.8,
            },
          ],
          color: '#EF2628',
        },
        {
          topic: '心理健康与压力管理',
          slots: [
            {
              sentence:
                '我很容易睡觉的时候乱想，尤其是想我为什么这么普通，过得生活很没有意义，然后我对茶和咖啡也比较容易过敏，很容易睡不着',
              slot: '睡前焦虑与过敏影响',
              id: 105,
              color: '#D9C9F0',
              sentiment: -0.8,
            },
          ],
          color: '#9366D6',
        },
        {
          topic: '语言学习与自我提升',
          slots: [
            {
              sentence: '我很容易睡觉的时候乱想，尤其是想我为什么这么普通，过得生活很没有意义',
              slot: '失眠与乱想',
              id: 105,
              color: '#D6C3BF',
              sentiment: -0.6,
            },
            {
              sentence: '我对茶和咖啡也比较容易过敏，很容易睡不着',
              slot: '饮食敏感性',
              id: 105,
              color: '#D6C3BF',
              sentiment: -0.4,
            },
          ],
          color: '#8C5649',
        },
        {
          topic: '心理健康与压力管理',
          slots: [
            {
              sentence: '有哪些舒缓压力的方法呢',
              slot: '压力缓解方法',
              id: 107,
              color: '#D9C9F0',
              sentiment: -0.2,
            },
          ],
          color: '#9366D6',
        },
      ]

      // ======= 参数配置，可以按需调整 =======
      const BANDWIDTH = 8 // KDE 带宽（单位：轮次）
      const BAND_HEIGHT = 40 // 每个 topic 条带的高度
      const BAND_GAP = 18 // 条带之间的垂直间距
      const SVG_WIDTH = 1000 // SVG 宽度（可水平滚动）
      const MARGIN = { top: 30, right: 30, bottom: 30, left: 180 }

      const messageDiv = document.getElementById('message')
      const svg = d3.select('#chart')

      // 页面加载后直接渲染
      renderFromJson(rawData)

      // 主流程：从 JSON 渲染
      function renderFromJson(rawData) {
        try {
          // 拍平成点：只关心 topic + turn(id)
          const points = []
          for (const group of rawData) {
            const topicName = group.topic ?? 'Unknown'
            const slots = group.slots ?? []
            for (const s of slots) {
              if (typeof s.id !== 'number') continue
              points.push({
                topic: topicName,
                turn: s.id,
                sentiment: typeof s.sentiment === 'number' ? s.sentiment : 0,
                color: group.color || '#1f77b4',
              })
            }
          }

          if (points.length === 0) {
            messageDiv.textContent =
              '错误：rawData 中没有有效的 slots.id 数据，请确认你已经把 JSON 正确粘贴到 rawData。'
            svg.selectAll('*').remove()
            return
          }

          // 按 topic 分组
          const byTopic = d3.group(points, (d) => d.topic)
          const topics = Array.from(byTopic.keys())

          // 时间范围
          const minTurn = d3.min(points, (d) => d.turn)
          const maxTurn = d3.max(points, (d) => d.turn)

          // 构建时间网格（这里按“轮次”为单位）
          const xs = d3.range(minTurn, maxTurn + 1)

          // 为每个 topic 计算 KDE
          const densities = [] // { topic, color, values: [{x, value}] }

          for (const topic of topics) {
            const pts = byTopic.get(topic) || []
            const color = pts[0]?.color || '#1f77b4'
            const values = computeKDE1D(
              pts.map((d) => d.turn),
              xs,
              BANDWIDTH,
            )
            densities.push({ topic, color, values })
          }

          // 计算全局最大密度，用来归一化高度
          const globalMax = d3.max(densities, (d) => d3.max(d.values, (v) => v.value)) || 1

          drawChart(densities, { minTurn, maxTurn, globalMax })
          messageDiv.textContent = `已载入数据：共 ${topics.length} 个 topic，轮次范围 [${minTurn}, ${maxTurn}]。`
        } catch (err) {
          console.error(err)
          messageDiv.textContent = '渲染出错，请检查 rawData 是否为合法的 JSON 数组结构。'
        }
      }

      // 1D KDE 计算：samples 是 turn 数组，xs 是要采样的时间点数组
      function computeKDE1D(samples, xs, bandwidth) {
        const n = samples.length
        if (n === 0) {
          return xs.map((x) => ({ x, value: 0 }))
        }

        const h = bandwidth
        const invH = 1 / h

        const values = xs.map((x) => ({ x, value: 0 }))

        for (const t of samples) {
          for (const v of values) {
            const u = (v.x - t) * invH
            v.value += gaussianKernel(u) // 权重默认=1
          }
        }

        // 归一化（严格与否问题不大，只要相对大小对就行）
        const normFactor = 1 / (n * h * Math.sqrt(2 * Math.PI))
        for (const v of values) {
          v.value *= normFactor
        }

        return values
      }

      // 标准高斯核 K(u) = exp(-u^2 / 2)
      function gaussianKernel(u) {
        return Math.exp(-0.5 * u * u)
      }

      // 绘图：每个 topic 一条 area 带
      function drawChart(densities, { minTurn, maxTurn, globalMax }) {
        svg.selectAll('*').remove()

        const numTopics = densities.length
        const innerHeight = numTopics * BAND_HEIGHT + (numTopics - 1) * BAND_GAP
        const innerWidth = SVG_WIDTH - MARGIN.left - MARGIN.right
        const svgHeight = innerHeight + MARGIN.top + MARGIN.bottom

        svg.attr('width', SVG_WIDTH).attr('height', svgHeight)

        const g = svg.append('g').attr('transform', `translate(${MARGIN.left},${MARGIN.top})`)

        // x 轴：轮次
        const xScale = d3.scaleLinear().domain([minTurn, maxTurn]).range([0, innerWidth])

        const xAxis = d3.axisBottom(xScale).ticks(10).tickFormat(d3.format('d'))

        g.append('g')
          .attr('class', 'axis x-axis')
          .attr('transform', `translate(0,${innerHeight})`)
          .call(xAxis)

        g.append('text')
          .attr('class', 'axis-label')
          .attr('x', innerWidth / 2) // 居中
          .attr('y', innerHeight + 25) // 在 x 轴下方一点
          .attr('text-anchor', 'middle')
          .attr('fill', '#555')
          .attr('font-size', 12)
          .text(`时间`) // 例如 时间：1 - 108

        // y 方向不做绝对坐标，只在每个 band 内做相对高度
        const yScale = d3
          .scaleLinear()
          .domain([0, globalMax])
          .range([0, BAND_HEIGHT * 0.9]) // 最大高度不超过 band 高度的 90%

        densities.forEach((d, index) => {
          const bandTop = index * (BAND_HEIGHT + BAND_GAP)
          const baselineY = bandTop + BAND_HEIGHT // 条带底部 y

          const area = d3
            .area()
            .x((v) => xScale(v.x))
            .y0(baselineY)
            .y1((v) => baselineY - yScale(v.value))
            .curve(d3.curveBasis)

          // 填充区域（1D KDE 曲线）
          g.append('path')
            .datum(d.values)
            .attr('d', area)
            .attr('fill', d.color || '#1f77b4')
            .attr('fill-opacity', 0.6)

          // 条带底线（辅助线）
          g.append('line')
            .attr('x1', 0)
            .attr('x2', innerWidth)
            .attr('y1', baselineY)
            .attr('y2', baselineY)
            .attr('stroke', '#eee')

          // topic 标签
          g.append('text')
            .attr('x', -10)
            .attr('y', bandTop + BAND_HEIGHT / 2)
            .attr('text-anchor', 'end')
            .attr('class', 'topic-label')
            .text(d.topic)
        })
      }
    </script>
  </body>
</html>
